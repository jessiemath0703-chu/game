<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Jessie Math - å…¬å› å€æ•¸å¤§æŒ‘æˆ°</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@500;900&family=Fredoka+One&display=swap" rel="stylesheet">
    
    <style>
        :root {
            /* Jessie Math å“ç‰Œè‰²ç³» */
            --brand-primary: #2c3e50;
            --brand-accent: #e67e22;
            --bg-color: #f0f2f5;
            --game-bg-top: #34495e;
            --game-bg-bottom: #2c3e50;
            --gcd-color: #e74c3c; /* ç´…è‰² */
            --lcm-color: #3498db; /* è—è‰² */
        }

        html, body {
            margin: 0; padding: 0; width: 100%; height: 100%;
            font-family: 'Noto Sans TC', sans-serif;
            background-color: var(--bg-color);
            display: flex; flex-direction: column;
            overflow: hidden; /* ç¦æ­¢æ»¾å‹• */
            user-select: none; /* ç¦æ­¢é¸å–æ–‡å­— */
        }

        /* --- å“ç‰Œå°è¦½åˆ— --- */
        header {
            height: 60px; background: white; padding: 0 20px;
            display: flex; justify-content: space-between; align-items: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1); z-index: 50;
        }
        
        /* å“ç‰Œ Logo é€£çµ */
        .brand { 
            font-family: 'Fredoka One', cursive; 
            font-size: 24px; 
            color: var(--brand-primary); 
            text-decoration: none; 
            display: flex; align-items: center; gap: 8px;
            transition: transform 0.2s;
        }
        .brand:active { transform: scale(0.95); }
        .brand i { color: var(--brand-accent); }

        /* å›é¦–é æŒ‰éˆ• */
        .home-link {
            text-decoration: none; color: #7f8c8d; font-weight: bold; font-size: 16px;
            display: flex; align-items: center; gap: 5px; transition: color 0.2s;
        }
        .home-link:hover { color: var(--brand-primary); }

        /* --- éŠæˆ²ä¸»å®¹å™¨ --- */
        .game-container {
            flex: 1; position: relative; width: 100%; height: 100%;
            display: flex; justify-content: center; background: #000;
        }

        /* éŠæˆ²ç•«å¸ƒ */
        canvas { display: block; width: 100%; height: 100%; }

        /* --- é ‚éƒ¨æ•¸æ“šæ¬„ (åˆ†æ•¸/æ™‚é–“) --- */
        .hud-bar {
            position: absolute; top: 0; left: 0; width: 100%;
            padding: 15px 20px; box-sizing: border-box;
            display: flex; justify-content: space-between;
            color: white; font-weight: 900; 
            font-size: 32px; /* å­—é«”åŠ å¤§ */
            text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
            pointer-events: none; z-index: 20;
        }
        .hud-item { display: flex; align-items: center; gap: 10px; }
        .hud-item i { font-size: 26px; } /* åœ–ç¤ºä¹ŸåŠ å¤§ */
        
        /* é—œå¡æç¤ºæ–‡å­— */
        .stage-indicator {
            position: absolute; top: 80px; width: 100%; text-align: center;
            font-size: 24px; color: #f1c40f; font-weight: 900;
            text-shadow: 0 0 10px rgba(0,0,0,0.8);
            opacity: 0.8; pointer-events: none;
        }

        /* --- åº•éƒ¨è¼¸å…¥å€ (æ‰‹æ©Ÿå„ªåŒ–) --- */
        .input-area {
            position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%);
            display: flex; gap: 10px; align-items: center;
            background: rgba(0,0,0,0.7); padding: 12px; border-radius: 15px;
            border: 1px solid rgba(255,255,255,0.3); z-index: 30;
            width: 90%; max-width: 420px; box-sizing: border-box;
        }

        #answer-input {
            flex: 1; height: 55px; text-align: center;
            border: 2px solid white; border-radius: 10px;
            background: rgba(255,255,255,0.95); font-weight: bold; outline: none;
            font-family: 'Fredoka One', sans-serif;
            font-size: 30px; color: #333;
        }

        #fire-btn {
            width: 90px; height: 55px; border: none; border-radius: 10px;
            background: var(--brand-accent); color: white; font-size: 24px; font-weight: bold;
            box-shadow: 0 4px 0 #d35400; cursor: pointer;
            display: flex; justify-content: center; align-items: center;
        }
        #fire-btn:active { transform: translateY(4px); box-shadow: none; }

        /* --- å·¦ä¸‹è§’æš«åœéˆ• --- */
        .ctrl-btn {
            position: absolute; bottom: 25px; left: 25px;
            background: rgba(255,255,255,0.25); border: 2px solid white; color: white;
            width: 60px; height: 60px; border-radius: 50%; /* åŠ å¤§å°ºå¯¸ */
            display: flex; justify-content: center; align-items: center;
            font-size: 28px; cursor: pointer; z-index: 40;
            transition: transform 0.1s;
        }
        .ctrl-btn:active { transform: scale(0.9); background: var(--brand-accent); }

        /* --- è¦†è“‹å±¤ (å…¨è¢å¹•é¸å–®) --- */
        .overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(44, 62, 80, 0.96); z-index: 100;
            display: flex; flex-direction: column; align-items: center; justify-content: flex-start;
            color: white; padding: 20px; box-sizing: border-box; overflow-y: auto;
        }
        .hidden { display: none !important; }

        /* --- èªªæ˜èˆ‡æ’è¡Œæ¦œå€å¡Šæ¨£å¼ --- */
        .box-container {
            background: rgba(255,255,255,0.1); border-radius: 12px; padding: 15px;
            margin: 10px 0; width: 100%; max-width: 500px; text-align: left;
            border: 1px solid rgba(255,255,255,0.2);
        }
        
        /* èªªæ˜åœ–ç¤º */
        .tutorial-row { display: flex; align-items: center; margin-bottom: 10px; font-size: 16px; }
        .dot { width: 16px; height: 16px; border-radius: 50%; margin-right: 12px; display: inline-block; }
        .red-dot { background: var(--gcd-color); box-shadow: 0 0 5px var(--gcd-color); }
        .blue-dot { background: var(--lcm-color); box-shadow: 0 0 5px var(--lcm-color); }

        /* æŒ‰éˆ•èˆ‡è¼¸å…¥æ¡† */
        .btn-main {
            background: var(--brand-accent); color: white; border: none; width: 100%; max-width: 300px;
            padding: 15px; font-size: 22px; border-radius: 50px; font-weight: bold;
            margin-top: 20px; box-shadow: 0 5px 15px rgba(230, 126, 34, 0.4); cursor: pointer;
            transition: transform 0.2s;
        }
        .btn-main:active { transform: scale(0.95); }

        input[type="text"], select {
            padding: 12px; font-size: 16px; border-radius: 8px; border: 1px solid #ccc;
            width: 100%; box-sizing: border-box; margin-top: 5px; color: #333;
            background: white;
        }
        .input-label { font-size: 14px; color: #ccc; margin-top: 15px; display: block; text-align: left;}

        /* --- æ’è¡Œæ¦œæ¨£å¼ --- */
        .leaderboard-box {
            width: 100%; max-width: 450px; background: white; border-radius: 12px;
            padding: 0; color: #333; margin-top: 20px; overflow: hidden;
            box-shadow: 0 5px 20px rgba(0,0,0,0.3);
        }
        
        .lb-tabs { display: flex; background: #eee; }
        .lb-tab {
            flex: 1; text-align: center; padding: 12px; cursor: pointer;
            font-weight: bold; color: #888; border-bottom: 4px solid transparent;
            font-size: 16px;
        }
        .lb-tab.active { 
            background: white; color: var(--brand-primary); 
            border-bottom-color: var(--brand-accent); 
        }
        
        .lb-content { padding: 10px 15px; min-height: 180px; }
        .rank-item {
            display: flex; justify-content: space-between; align-items: center;
            padding: 12px 0; border-bottom: 1px dashed #ddd; font-size: 18px;
        }
        .rank-item:last-child { border: none; }
        .rank-idx { 
            font-weight: 900; width: 30px; 
            color: #bdc3c7; font-style: italic; 
        }
        .rank-top { color: var(--brand-accent); font-size: 20px; } /* å‰ä¸‰åç‰¹åˆ¥è‰² */

        /* æ‰‹æ©Ÿ RWD ç´°éƒ¨èª¿æ•´ */
        @media (max-width: 400px) {
            .hud-bar { font-size: 24px; padding: 10px; }
            #fire-btn { width: 70px; font-size: 20px; }
            .tutorial-row { font-size: 14px; }
        }

    </style>
</head>
<body>

    <header>
        <a href="https://jessiemath0703-chu.github.io/website/" class="brand">
            <i class="fas fa-cube"></i> Jessie Math
        </a>
        
        <a href="https://jessiemath0703-chu.github.io/website/" class="home-link">
            <i class="fas fa-home"></i> <span>é¦–é </span>
        </a>
    </header>

    <div class="game-container">
        <canvas id="game-canvas"></canvas>

        <div class="hud-bar">
            <div class="hud-item"><i class="fas fa-star" style="color:#f1c40f;"></i> <span id="score-el">0</span></div>
            <div class="hud-item"><i class="fas fa-clock"></i> <span id="time-el">60</span>s</div>
        </div>

        <div id="stage-msg" class="stage-indicator"></div>

        <div id="pause-btn" class="ctrl-btn"><i class="fas fa-pause"></i></div>

        <div id="input-ui" class="input-area" style="display: none;">
            <input type="tel" pattern="\d*" id="answer-input" placeholder="?" autocomplete="off">
            <button id="fire-btn">ğŸš€</button>
        </div>

        <div id="start-screen" class="overlay">
            <div style="font-size: 60px; color: var(--brand-accent); margin: 10px 0;"><i class="fas fa-rocket"></i></div>
            <h2 style="margin: 0 0 15px 0; font-size: 32px;">å…¬å› å€æ•¸æŒ‘æˆ°</h2>
            
            <div class="box-container">
                <div style="font-weight: bold; margin-bottom: 12px; color: #f1c40f; font-size: 18px;">
                    <i class="fas fa-info-circle"></i> ç¬¦è™Ÿè¦å‰‡
                </div>
                <div class="tutorial-row">
                    <span class="dot red-dot"></span> 
                    <span>ç´…è‰² <strong>( a , b )</strong> = æœ€å¤§å…¬å› æ•¸</span>
                </div>
                <div class="tutorial-row">
                    <span class="dot blue-dot"></span> 
                    <span>è—è‰² <strong>[ a , b ]</strong> = æœ€å°å…¬å€æ•¸</span>
                </div>
            </div>

            <div style="width: 100%; max-width: 320px;">
                <label class="input-label">æŒ‘æˆ°è€…åå­— (Name)</label>
                <input type="text" id="player-name" placeholder="è«‹è¼¸å…¥åå­—">

                <label class="input-label">é¸æ“‡é—œå¡ (60ç§’æŒ‘æˆ°)</label>
                <select id="mode-select" style="border: 2px solid var(--brand-accent); font-weight: bold; color: var(--brand-primary);">
                    <option value="GCD">ğŸ”´ å…¬å› æ•¸ç‰¹è¨“ (GCD)</option>
                    <option value="LCM">ğŸ”µ å…¬å€æ•¸ç‰¹è¨“ (LCM)</option>
                    <option value="MIXED">ğŸŸ£ æ··åˆå¤§äº‚é¬¥ (Mixed)</option>
                </select>
                
                <div style="display:flex; gap:10px;">
                    <div style="flex:1;">
                        <label class="input-label">é›£åº¦ (Level)</label>
                        <select id="diff-select">
                            <option value="EASY">å…¥é–€</option>
                            <option value="NORMAL" selected>æ¨™æº–</option>
                            <option value="HARD">æŒ‘æˆ°</option>
                        </select>
                    </div>
                </div>
            </div>

            <button id="start-btn" class="btn-main">é–‹å§‹æŒ‘æˆ°</button>
        </div>

        <div id="pause-screen" class="overlay hidden">
            <h2 style="margin-top: 120px; font-size: 36px;">éŠæˆ²æš«åœ</h2>
            <button id="resume-btn" class="btn-main">ç¹¼çºŒéŠæˆ²</button>
            <button id="quit-btn" style="background:transparent; border:2px solid white; margin-top:20px; padding:10px 40px; border-radius:50px; color:white; font-weight:bold; cursor:pointer;">æ”¾æ£„é‡ä¾†</button>
        </div>

        <div id="gameover-screen" class="overlay hidden">
            <h2>æ™‚é–“åˆ°ï¼</h2>
            <div style="font-size: 16px; color:#ccc;">æœ€çµ‚å¾—åˆ†</div>
            <div style="font-size: 70px; font-weight: 900; color: var(--brand-accent); text-shadow: 0 0 20px rgba(230, 126, 34, 0.5);" id="final-score">0</div>

            <div class="leaderboard-box">
                <div class="lb-tabs">
                    <div id="tab-all" class="lb-tab active" onclick="switchTab('ALL')">ğŸŒ æœ¬æ©Ÿé«˜æ‰‹</div>
                    <div id="tab-self" class="lb-tab" onclick="switchTab('SELF')">ğŸ‘¤ æˆ‘çš„ç´€éŒ„</div>
                </div>
                
                <div id="leaderboard-list" class="lb-content">
                    </div>
                
                <div style="padding: 10px; background: #f9f9f9; border-top: 1px solid #eee; display: flex; justify-content: space-between;">
                     <span style="font-size:12px; color:#999;">*ç´€éŒ„å­˜æ–¼æ­¤è£ç½®</span>
                     <button onclick="clearLeaderboard()" style="font-size:12px; color:#999; background:none; border:none; cursor:pointer; text-decoration: underline;">æ¸…ç©ºç´€éŒ„</button>
                </div>
            </div>

            <button id="retry-btn" class="btn-main">å†ç©ä¸€æ¬¡</button>
        </div>
    </div>

    <script>
        // --- 1. æ ¸å¿ƒè®Šæ•¸è¨­å®š ---
        const canvas = document.getElementById('game-canvas');
        const ctx = canvas.getContext('2d');
        let width, height;

        // éŠæˆ²ç‹€æ…‹
        let gameState = 'MENU'; 
        let score = 0;
        let totalTime = 60; // å›ºå®š 60 ç§’
        let timeLeft = totalTime;
        let meteors = [];
        let particles = [];
        let timerInterval;
        let spawnCounter = 0;
        let currentPlayer = "Player";
        let currentLbTab = 'ALL'; // ALL=æœ¬æ©Ÿé«˜æ‰‹, SELF=æˆ‘çš„ç´€éŒ„
        
        let settings = { difficulty: 'NORMAL', mode: 'GCD', speedMul: 1.0 };

        // DOM å…ƒç´ å¿«å–
        const screens = {
            start: document.getElementById('start-screen'),
            pause: document.getElementById('pause-screen'),
            gameover: document.getElementById('gameover-screen'),
            input: document.getElementById('input-ui')
        };
        const els = {
            score: document.getElementById('score-el'),
            time: document.getElementById('time-el'),
            stageMsg: document.getElementById('stage-msg'),
            finalScore: document.getElementById('final-score'),
            input: document.getElementById('answer-input'),
            lbList: document.getElementById('leaderboard-list'),
            tabAll: document.getElementById('tab-all'),
            tabSelf: document.getElementById('tab-self')
        };

        // æ•¸å­¸å‡½å¼
        const gcd = (a, b) => b === 0 ? a : gcd(b, a % b);
        const lcm = (a, b) => (a * b) / gcd(a, b);

        // --- 2. ç•«é¢èª¿æ•´ (RWD) ---
        function resize() {
            width = canvas.width = document.querySelector('.game-container').clientWidth;
            height = canvas.height = document.querySelector('.game-container').clientHeight;
        }
        window.addEventListener('resize', resize);
        resize();

        // --- 3. éŠæˆ²æµç¨‹æ§åˆ¶ ---
        function initGame() {
            // è®€å–ç©å®¶è¼¸å…¥
            const name = document.getElementById('player-name').value.trim();
            if(!name) { alert("è«‹å…ˆè¼¸å…¥æ‚¨çš„åå­—ï¼"); return; }
            
            currentPlayer = name;
            settings.difficulty = document.getElementById('diff-select').value;
            settings.mode = document.getElementById('mode-select').value;
            
            // é‡ç½®æ•¸å€¼
            score = 0;
            timeLeft = totalTime;
            meteors = [];
            particles = [];
            spawnCounter = 0;
            settings.speedMul = 1.0;
            
            updateHUD();
            
            // è¨­å®šé—œå¡æ¨™é¡Œ
            let modeName = "";
            if(settings.mode === 'GCD') modeName = "ğŸ”´ å…¬å› æ•¸ç‰¹è¨“";
            else if(settings.mode === 'LCM') modeName = "ğŸ”µ å…¬å€æ•¸ç‰¹è¨“";
            else modeName = "ğŸŸ£ æ··åˆå¤§äº‚é¬¥";
            els.stageMsg.innerText = modeName;

            // åˆ‡æ›ç•«é¢
            screens.start.classList.add('hidden');
            screens.gameover.classList.add('hidden');
            screens.input.style.display = 'flex';
            els.input.value = '';
            els.input.focus();

            gameState = 'PLAYING';
            let lastTime = performance.now();
            
            // å•Ÿå‹•éŠæˆ²è¿´åœˆ
            function gameLoop(timestamp) {
                if(gameState !== 'PLAYING') return;
                const dt = timestamp - lastTime;
                lastTime = timestamp;
                loop(dt);
                requestAnimationFrame(gameLoop);
            }
            requestAnimationFrame(gameLoop);

            // å•Ÿå‹•å€’æ•¸è¨ˆæ™‚
            clearInterval(timerInterval);
            timerInterval = setInterval(tick, 1000);
        }

        function tick() {
            if(gameState !== 'PLAYING') return;
            timeLeft--;
            updateHUD();
            // æ™‚é–“è¶Šå°‘ï¼Œé€Ÿåº¦ç¨å¾®è®Šå¿«
            if(timeLeft % 10 === 0 && timeLeft > 0) settings.speedMul += 0.1;
            if(timeLeft <= 0) gameOver();
        }

        function updateHUD() {
            els.score.innerText = score;
            els.time.innerText = timeLeft;
        }

        // --- 4. éŠæˆ²ç‰©ä»¶ (éš•çŸ³/æ°£çƒ) ---
        class Meteor {
            constructor() {
                this.r = 45; // æ°£çƒåŠå¾‘
                // ç¢ºä¿æ°£çƒåœ¨ç•«é¢å…§
                this.x = Math.random() * (width - 2 * this.r) + this.r;
                this.y = -60;
                this.speed = (Math.random() * 0.5 + 0.8) * settings.speedMul;
                
                // æ±ºå®šé¡å‹
                if (settings.mode === 'GCD') this.type = 'GCD';
                else if (settings.mode === 'LCM') this.type = 'LCM';
                else this.type = Math.random() > 0.5 ? 'GCD' : 'LCM';
                
                this.color = this.type === 'GCD' ? '#e74c3c' : '#3498db';
                this.genNumbers();
            }

            genNumbers() {
                let range = settings.difficulty === 'EASY' ? [2, 8] : (settings.difficulty === 'NORMAL' ? [4, 12] : [6, 20]);
                let mulRange = settings.difficulty === 'EASY' ? [1, 5] : [1, 9];
                
                let valid = false;
                while(!valid) {
                    if (this.type === 'GCD') {
                        let c = Math.floor(Math.random() * (range[1]-range[0]) + range[0]);
                        let m1 = Math.floor(Math.random() * (mulRange[1]-1) + 1);
                        let m2 = Math.floor(Math.random() * (mulRange[1]-1) + 1);
                        if(m1===m2) m2++;
                        this.n1 = c*m1; this.n2 = c*m2;
                        this.ans = gcd(this.n1, this.n2);
                    } else {
                        let limit = settings.difficulty === 'EASY' ? 30 : (settings.difficulty === 'NORMAL' ? 100 : 200);
                        this.n1 = Math.floor(Math.random() * (range[1]-2) + 2);
                        this.n2 = Math.floor(Math.random() * (range[1]-2) + 2);
                        if(this.n1===this.n2) this.n2++;
                        this.ans = lcm(this.n1, this.n2);
                        if(this.ans > limit) continue; 
                    }
                    valid = true;
                }
            }

            update() { this.y += this.speed; }

            draw() {
                // ç•«æ°£çƒæœ¬é«”
                ctx.beginPath();
                ctx.arc(this.x, this.y, this.r, 0, Math.PI*2);
                ctx.fillStyle = this.color; ctx.fill();
                ctx.strokeStyle = 'white'; ctx.lineWidth = 4; ctx.stroke();

                // ç•«æ–‡å­—
                ctx.fillStyle = 'white';
                ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
                ctx.font = 'bold 24px Arial';
                
                // åš´æ ¼ç¬¦è™Ÿ: GCDç”¨(), LCMç”¨[]
                let txt = this.type === 'GCD' ? `( ${this.n1} , ${this.n2} )` : `[ ${this.n1} , ${this.n2} ]`;
                ctx.fillText(txt, this.x, this.y);
            }
        }

        // --- 5. ç²’å­ç‰¹æ•ˆ ---
        class Particle {
            constructor(x, y, color) {
                this.x = x; this.y = y; this.color = color;
                this.vx = (Math.random()-0.5)*10; this.vy = (Math.random()-0.5)*10;
                this.life = 1.0;
            }
            update() { this.x+=this.vx; this.y+=this.vy; this.life-=0.05; }
            draw() {
                ctx.globalAlpha = Math.max(0, this.life);
                ctx.fillStyle = this.color;
                ctx.beginPath(); ctx.arc(this.x, this.y, 5, 0, Math.PI*2); ctx.fill();
                ctx.globalAlpha = 1;
            }
        }

        // --- 6. ç•«é¢æ›´æ–°è¿´åœˆ ---
        function loop(dt) {
            // æ¸…é™¤ç•«å¸ƒ
            ctx.clearRect(0, 0, width, height);
            
            // ç•«èƒŒæ™¯è‰² (é˜²æ­¢æ®˜å½±)
            ctx.fillStyle = '#34495e'; ctx.fillRect(0,0,width,height);

            // ç”Ÿæˆé‚è¼¯
            spawnCounter += dt;
            let spawnRate = (settings.mode === 'MIXED') ? 1200 : 1500;
            if(settings.difficulty === 'HARD') spawnRate -= 400;

            if(spawnCounter > spawnRate) {
                meteors.push(new Meteor());
                spawnCounter = 0;
            }

            // æ›´æ–°éš•çŸ³
            for(let i=meteors.length-1; i>=0; i--) {
                let m = meteors[i];
                m.update();
                m.draw();
                // è§¸åº•æ‰£åˆ†
                if(m.y - m.r > height) {
                    meteors.splice(i, 1);
                    score = Math.max(0, score - 20);
                    updateHUD();
                    createExplosion(m.x, height, '#fff');
                }
            }

            // æ›´æ–°ç‰¹æ•ˆ
            for(let i=particles.length-1; i>=0; i--) {
                let p = particles[i];
                p.update();
                p.draw();
                if(p.life <= 0) particles.splice(i, 1);
            }
        }

        // --- 7. ç­”é¡Œåˆ¤å®š ---
        function checkAnswer() {
            let val = parseInt(els.input.value);
            els.input.value = '';
            els.input.focus();
            if(isNaN(val)) return;

            // æ‰¾å‡ºæ‰€æœ‰æ°£çƒï¼Œå„ªå…ˆæ‰“æ“Šæœ€ä¸‹é¢çš„
            let sorted = [...meteors].sort((a,b) => b.y - a.y);
            let hit = false;
            for(let m of sorted) {
                if(m.ans === val) {
                    hit = true;
                    // åˆ†æ•¸è¨ˆç®—
                    let base = (m.type === 'LCM' || settings.mode === 'MIXED') ? 150 : 100;
                    score += base;
                    createExplosion(m.x, m.y, m.color);
                    let idx = meteors.indexOf(m);
                    if(idx > -1) meteors.splice(idx, 1);
                    break;
                }
            }
            if(!hit) {
                score = Math.max(0, score - 10);
                // éŒ¯èª¤éœ‡å‹•ç‰¹æ•ˆ
                canvas.style.transform = 'translateX(5px)';
                setTimeout(()=>canvas.style.transform='none', 50);
            }
            updateHUD();
        }

        function createExplosion(x, y, color) {
            for(let i=0; i<15; i++) particles.push(new Particle(x, y, color));
        }

        // --- 8. ç‹€æ…‹æ§åˆ¶ (çµæŸ/æš«åœ/é‡ä¾†) ---
        function gameOver() {
            gameState = 'GAMEOVER';
            clearInterval(timerInterval);
            screens.input.style.display = 'none';
            screens.gameover.classList.remove('hidden');
            els.finalScore.innerText = score;
            saveRecord(currentPlayer, score);
        }

        function togglePause() {
            if(gameState === 'PLAYING') {
                gameState = 'PAUSED';
                screens.pause.classList.remove('hidden');
                els.input.blur();
            } else if (gameState === 'PAUSED') {
                gameState = 'PLAYING';
                screens.pause.classList.add('hidden');
                // æ¢å¾© Loop
                let lastTime = performance.now(); 
                function gameLoop(timestamp) {
                    if(gameState !== 'PLAYING') return;
                    const dt = timestamp - lastTime;
                    lastTime = timestamp;
                    loop(dt);
                    requestAnimationFrame(gameLoop);
                }
                requestAnimationFrame(gameLoop);
                
                els.input.focus();
            }
        }

        function resetToMenu() {
            gameState = 'MENU';
            screens.pause.classList.add('hidden');
            screens.gameover.classList.add('hidden');
            screens.start.classList.remove('hidden');
            screens.input.style.display = 'none';
            ctx.clearRect(0,0,width,height);
        }

        // --- 9. é›™é‡æ’è¡Œæ¦œç³»çµ± ---
        function saveRecord(name, score) {
            // è®€å–èˆŠç´€éŒ„
            let records = JSON.parse(localStorage.getItem('jessieMathRecords_v5') || '[]');
            // åŠ å…¥æ–°ç´€éŒ„
            records.push({name, score, mode: settings.mode, date: new Date().getTime()});
            // æ’åº
            records.sort((a,b) => b.score - a.score);
            // åªä¿ç•™å‰ 200 ç­†ï¼Œé¿å…ç©ºé–“ä¸è¶³
            if(records.length > 200) records = records.slice(0, 200);
            
            localStorage.setItem('jessieMathRecords_v5', JSON.stringify(records));
            
            // é è¨­é¡¯ç¤ºç¸½æ¦œ
            switchTab('ALL');
        }

        function switchTab(tab) {
            currentLbTab = tab;
            // UI åˆ‡æ›
            els.tabAll.className = (tab === 'ALL') ? 'lb-tab active' : 'lb-tab';
            els.tabSelf.className = (tab === 'SELF') ? 'lb-tab active' : 'lb-tab';
            renderLeaderboard();
        }

        function renderLeaderboard() {
            let records = JSON.parse(localStorage.getItem('jessieMathRecords_v5') || '[]');
            let listToRender = [];

            if (currentLbTab === 'ALL') {
                // å–å…¨åŸŸå‰ 5 å
                listToRender = records.slice(0, 5);
            } else {
                // ç¯©é¸ç›®å‰ç©å®¶çš„åå­— (ä¸åˆ†å¤§å°å¯«) ä¸¦å–å‰ 5
                listToRender = records.filter(r => r.name.toLowerCase() === currentPlayer.toLowerCase()).slice(0, 5);
            }

            els.lbList.innerHTML = '';
            if(listToRender.length === 0) {
                let msg = (currentLbTab === 'ALL') ? 'æš«ç„¡ç´€éŒ„' : 'æ‚¨é‚„æ²’æœ‰ç´€éŒ„å–”';
                els.lbList.innerHTML = `<div style="text-align:center; color:#999; padding:30px;">${msg}</div>`;
                return;
            }
            
            listToRender.forEach((r, i) => {
                let div = document.createElement('div');
                div.className = 'rank-item';
                // å‰ä¸‰ååŠ çš‡å† é¡è‰²
                let idxClass = (i < 3) ? 'rank-idx rank-top' : 'rank-idx';
                
                div.innerHTML = `
                    <span class="${idxClass}">${i+1}</span>
                    <span style="flex:1; margin-left:10px;">
                        ${r.name} 
                        <span style="color:#aaa; font-size:12px; margin-left:5px;">[${r.mode}]</span>
                    </span>
                    <span style="font-weight:bold; color:#e67e22;">${r.score}</span>
                `;
                els.lbList.appendChild(div);
            });
        }
        
        function clearLeaderboard() {
            if(confirm("ç¢ºå®šè¦æ¸…ç©ºæ‰€æœ‰äººçš„ç´€éŒ„å—ï¼Ÿ(ç„¡æ³•å¾©åŸ)")) {
                localStorage.removeItem('jessieMathRecords_v5');
                renderLeaderboard();
            }
        }

        // --- 10. äº‹ä»¶ç¶å®š ---
        document.getElementById('start-btn').onclick = initGame;
        document.getElementById('pause-btn').onclick = togglePause;
        document.getElementById('resume-btn').onclick = togglePause;
        document.getElementById('quit-btn').onclick = resetToMenu;
        document.getElementById('retry-btn').onclick = resetToMenu;
        
        // æ”¯æ´è§¸æ§èˆ‡æ»‘é¼ é»æ“Š
        document.getElementById('fire-btn').addEventListener('touchstart', (e) => { e.preventDefault(); checkAnswer(); });
        document.getElementById('fire-btn').addEventListener('click', checkAnswer);
        
        // éµç›¤æ”¯æ´
        window.addEventListener('keydown', (e) => {
            if(e.key === 'Enter') {
                if(gameState === 'PLAYING') checkAnswer();
                if(gameState === 'MENU' && !screens.start.classList.contains('hidden')) initGame();
            }
        });
        
        // åˆå§‹åŒ–æ’è¡Œæ¦œé¡¯ç¤º
        renderLeaderboard();

    </script>
</body>
</html>